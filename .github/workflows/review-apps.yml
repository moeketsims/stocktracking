name: Review App

on:
  pull_request:
    types: [opened, reopened, synchronize, closed]

jobs:
  deploy-review:
    name: Deploy Review App
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'

    steps:
      - uses: actions/checkout@v4

      - name: Install Heroku CLI
        run: curl https://cli-assets.heroku.com/install.sh | sh

      - name: Login to Heroku Container Registry
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: heroku container:login

      - name: Create or update review app
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          APP_NAME="stocktrack-pr-${{ github.event.pull_request.number }}"

          # Check if app exists
          if heroku apps:info --app "$APP_NAME" 2>/dev/null; then
            echo "App $APP_NAME exists, pushing update..."
          else
            echo "Creating review app $APP_NAME..."
            heroku create "$APP_NAME" --stack container

            # Set config vars for review environment
            heroku config:set \
              SUPABASE_URL="${{ secrets.REVIEW_SUPABASE_URL }}" \
              SUPABASE_ANON_KEY="${{ secrets.REVIEW_SUPABASE_ANON_KEY }}" \
              SUPABASE_SERVICE_KEY="${{ secrets.REVIEW_SUPABASE_SERVICE_KEY }}" \
              ENVIRONMENT=review \
              --app "$APP_NAME"
          fi

          # Build and deploy
          heroku container:push web --app "$APP_NAME"
          heroku container:release web --app "$APP_NAME"

          echo "Review app deployed at: https://$APP_NAME.herokuapp.com"

      - name: Comment PR with review app URL
        uses: actions/github-script@v7
        with:
          script: |
            const appName = `stocktrack-pr-${context.payload.pull_request.number}`;
            const url = `https://${appName}.herokuapp.com`;
            const body = `## Review App Deployed\n\nURL: ${url}\n\n_This review app will be destroyed when the PR is closed._`;

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });

            const existing = comments.data.find(c => c.body.includes('Review App Deployed'));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body,
              });
            }

  destroy-review:
    name: Destroy Review App
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'

    steps:
      - name: Install Heroku CLI
        run: curl https://cli-assets.heroku.com/install.sh | sh

      - name: Destroy review app
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          APP_NAME="stocktrack-pr-${{ github.event.pull_request.number }}"
          if heroku apps:info --app "$APP_NAME" 2>/dev/null; then
            heroku apps:destroy --app "$APP_NAME" --confirm "$APP_NAME"
            echo "Review app $APP_NAME destroyed"
          else
            echo "Review app $APP_NAME does not exist, skipping"
          fi
